<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
   integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
   integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<script type="text/javascript">
   function ellipsis(text, maxLength) {
      if (text.length > maxLength) {
         return text.substring(0, maxLength) + '...';
      }
      return text;
   }

   function sub_text(text, sub) {
      return text == '' ? sub : text;
   }

   // Function to disable or enable submit button based on checkbox
   function toggleSubmit() {
      var submitBtn = document.getElementById("submitBtn");
      var checkbox = document.getElementById("checkboxAEQ");
      submitBtn.disabled = checkbox.checked;
   }

   window.onload = function () {
      // Set up icons for different origins
      const blueIcon = new L.Icon({
         iconUrl: 'static/marker-icon-2x-blue.png',
         iconSize: [25, 41],
         iconAnchor: [12, 41],
         popupAnchor: [1, -34],
         tooltipAnchor: [16, -28],
         shadowSize: [41, 41]
      });
      const redIcon = new L.Icon({
         iconUrl: 'static/marker-icon-2x-red.png',
         iconSize: [25, 41],
         iconAnchor: [12, 41],
         popupAnchor: [1, -34],
         tooltipAnchor: [16, -28],
         shadowSize: [41, 41]
      });
      const greenIcon = new L.Icon({
         iconUrl: 'static/marker-icon-2x-green.png',
         iconSize: [25, 41],
         iconAnchor: [12, 41],
         popupAnchor: [1, -34],
         tooltipAnchor: [16, -28],
         shadowSize: [41, 41]
      });

      // Create icon mapping based on origin
      const icons = {
         'photo': blueIcon,
         'streetview-google': redIcon,
         'streetview-user': greenIcon
      };

      document.getElementById('frm1').onsubmit = async function (e) {
         e.preventDefault();

         // Get the form input values
         const el = document.getElementById("frm1").elements;
         const submit_text = el["texto"].value;
         const macro = el["macro"].value;  // Single value from dropdown
         const origem = el["origem"].value;  // Single value from dropdown
         const isAEQ = el["checkboxAEQ"].checked;

         const data = { 'search': submit_text, 'macro': macro, 'origin': origem, 'isAEQ': isAEQ };

         const response = await fetch('/', {
            'method': 'POST',
            'credentials': "omit",
            'headers': {
               "Content-Type": "application/json",
            },
            'body': JSON.stringify(data),
         });

         const myJson = await response.json();
         markers.clearLayers();

         // Loop through JSON data and create markers
         myJson.forEach(function (item, index) {
            const marker = L.marker([item.lat, item.long], { icon: icons[item['origin']] });
            const thumb_url = 'thumb/' + item['originalfilepath'];

            const popupContent = `<div><a href='image/${item['originalfilepath']}'>
                                    <img class='marker_img' src='${thumb_url}'></a>
                                    <p class="fw-bold fs-5">${sub_text(item["name"], "[sem nome]")} - ${sub_text(item["macro"], "[sem macro]")}</p>
                                    <p>${sub_text(ellipsis(item["description"].join('; '), 60), "[sem descrição]")}</p></div>`;
            marker.bindPopup(popupContent, { autoPan: true });
            markers.addLayer(marker);
         });
         return false;
      }
   }
</script>

<div class="container-fluid p-0">
   <div class="row h-100 m-0">
      <div class="col-md-4 mt-3">
         <form id="frm1" name="frm1" method="post">
            <div class="mb-3">
               <label for="macro" class="form-label">Macro</label>
               <select name="macro" id="macro" class="form-select">
                  <option value="todos">Todos</option>
                  <option value="CDI">CDI</option>
                  <option value="CEPE">CEPE</option>
                  <option value="CRUSP">CRUSP</option>
                  <option value="DAMA01">DAMA01</option>
                  <option value="ECA">ECA</option>
                  <option value="EEFE">EEFE</option>
                  <option value="EP">EP</option>
                  <option value="FAU">FAU</option>
                  <option value="FEA">FEA</option>
                  <option value="FFLCH">FFLCH</option>
                  <option value="FMVZ">FMVZ</option>
                  <option value="HU">HU</option>
                  <option value="IAG">IAG</option>
                  <option value="ICB">ICB</option>
                  <option value="ICB">ICB</option>
                  <option value="IEE">IEE</option>
                  <option value="IF">IF</option>
                  <option value="IME">IME</option>
                  <option value="IO">IO</option>
                  <option value="IP">IP</option>
                  <option value="IPEN">IPEN</option>
                  <option value="IPT">IPT</option>
                  <option value="IRI">IRI</option>
                  <option value="acadepol">acadepol</option>
                  <option value="antiga prefeitura">antiga prefeitura</option>
                  <option value="av. almeida prado">av. almeida prado</option>
                  <option value="av. antonio barros ulhoa cintra">av. antonio barros ulhoa cintra</option>
                  <option value="av. da universidade">av. da universidade</option>
                  <option value="av. ernesto leme">av. ernesto leme</option>
                  <option value="av. lineu prestes">av. lineu prestes</option>
                  <option value="av. luciano gualberto">av. luciano gualberto</option>
                  <option value="av. lúcio martins rodrigues">av. lúcio martins rodrigues</option>
                  <option value="av. mello moraes">av. mello moraes</option>
                  <option value="bancos">bancos</option>
                  <option value="barracões">barracões</option>
                  <option value="bio">bio</option>
                  <option value="brasiliana">brasiliana</option>
                  <option value="centro de informações">centro de informações</option>
                  <option value="educação">educação</option>
                  <option value="geo">geo</option>
                  <option value="inova">inova</option>
                  <option value="instituto butantã">instituto butantã</option>
                  <option value="lago">lago</option>
                  <option value="matão">matão</option>
                  <option value="nova reitoria">nova reitoria</option>
                  <option value="praça do relógio">praça do relógio</option>
                  <option value="praça do relógio solar">praça do relógio solar</option>
                  <option value="prefeitura">prefeitura</option>
                  <option value="ptrem">ptrem</option>
                  <option value="químicas">químicas</option>
                  <option value="radio tv USP">radio tv USP</option>
                  <option value="raia">raia</option>
                  <option value="subestação de energia">subestação de energia</option>
                  <option value="sweden">sweden</option>
                  <option value="terminal de ônibus">terminal de ônibus</option>
               </select>
            </div>

            <div class="mb-3">
               <label for="origem" class="form-label">Origem</label>
               <select name="origem" id="origem" class="form-select">
                  <option value="todos">Todos</option>
                  <option value="photo">Photo</option>
                  <option value="streetview-google">Streetview Google</option>
                  <option value="streetview-user">Streetview User</option>
               </select>
            </div>

            <div class="mb-3">
               <label for="texto" class="form-label">Texto</label>
               <textarea name="texto" id="texto" class="form-control"></textarea>
            </div>

            <div class="mb-3">
               <label class="form-label">Você é da AEQ?</label>
               <div class="form-check form-switch d-flex justify-content-between align-items-center"
                  style="width: 32%; padding: 0px;">
                  <span>não</span>
                  <input class="form-check-input" style="margin-left: 0;" type="checkbox" id="checkboxAEQ"
                     onclick="toggleSubmit()">
                  <span>sim</span>
               </div>
            </div>
            <button type=" submit" id="submitBtn" class="btn btn-primary" disabled>Submit</button>
         </form>
      </div>

      <div class="col-md-8 h-100 p-0 m-0" id="map"></div>
   </div>
</div>

<style>
   #map {
      height: 600px;
   }

   .marker_img {
      max-width: 100%;
      max-height: 180px;
   }

   .leaflet-popup-content {
      width: 200px !important;
      max-height: 300px !important;
      overflow-y: auto !important;
   }
</style>

<script>
   var map = L.map('map').setView([-23.55873855243587, -46.72968100025308], 13);
   L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
   }).addTo(map);

   var markers = L.layerGroup().addTo(map);
</script>